# üé¨ Resumo Detalhado do Jupyter Notebook: aula4.ipynb

**üìö T√≠tulo da Aula Pr√°tica:** Integra√ß√£o entre PostgreSQL (Pagila) e APIs com Python

**üéØ Objetivo Geral da Atividade:**  
Este notebook tem como objetivo central capacitar o usu√°rio na integra√ß√£o de dados provenientes de um banco de dados PostgreSQL (o banco de exemplo "Pagila") com informa√ß√µes obtidas em tempo real de diversas APIs externas. A atividade abrange a consulta, combina√ß√£o, an√°lise, transforma√ß√£o e visualiza√ß√£o desses dados heterog√™neos, utilizando Python e suas bibliotecas padr√£o para manipula√ß√£o e an√°lise de dados.

**üõ†Ô∏è Principais Ferramentas e Tecnologias Utilizadas:**
* üêç **Linguagem de Programa√ß√£o:** Python
* üíª **Ambiente de Desenvolvimento:** Jupyter Notebook
* üóÑÔ∏è **Banco de Dados:** PostgreSQL (com o banco de dados de exemplo "Pagila")
* üîó **Intera√ß√£o com Banco de Dados:** Biblioteca `psycopg2` para conex√£o e execu√ß√£o de queries.
* üìä **Manipula√ß√£o e An√°lise de Dados:** Biblioteca `pandas` para estruturas de dados (DataFrames) e opera√ß√µes de an√°lise.
* üåê **Requisi√ß√µes a APIs Externas:** Biblioteca `requests` para realizar chamadas HTTP.
* ‚òÅÔ∏è **APIs Externas Espec√≠ficas:**
    * üå¶Ô∏è WeatherAPI (para dados clim√°ticos como temperatura)
    * üè≠ AirVisual API (IQAir) (para dados de qualidade do ar - AQI)
    * üåç REST Countries API (para dados populacionais e regionais de pa√≠ses)
* üîë **Gerenciamento de Configura√ß√µes:** Biblioteca `dotenv` para carregar vari√°veis de ambiente (como chaves de API e credenciais do banco) de um arquivo `.env`.
* üìà **Visualiza√ß√£o de Dados:** Bibliotecas `matplotlib` e `seaborn` para a cria√ß√£o de gr√°ficos.
* üìù **Formata√ß√£o de Sa√≠da:** Biblioteca `tabulate` para exibir DataFrames de forma leg√≠vel no console.
* ‚ûó **Opera√ß√µes Num√©ricas:** Biblioteca `numpy`.
* üóÇÔ∏è **Outras:** M√≥dulo `os` para interagir com o sistema operacional (ex: caminhos de arquivo para cache) e `time` para poss√≠veis delays em chamadas de API.

**üß© Estrutura e Configura√ß√£o Inicial do Notebook:**

1.  üì¶ **Importa√ß√£o de Bibliotecas:** Todas as bibliotecas listadas acima s√£o importadas no in√≠cio.
2.  üîê **Carregamento de Vari√°veis de Ambiente:** As credenciais do banco de dados (PG\_DB, PG\_USER, etc.) e as chaves das APIs (WEATHER\_API\_KEY, AIRVISUAL\_API\_KEY) s√£o carregadas do arquivo `.env`.
3.  üîå **Conex√£o com PostgreSQL:** √â estabelecida uma conex√£o com o banco de dados Pagila, e a vers√£o do PostgreSQL √© verificada e impressa.
4.  üõ†Ô∏è **Fun√ß√µes Utilit√°rias Principais:**
    * üèÉ‚Äç‚ôÇÔ∏è `run_query(sql, db_conn)`: Executa uma consulta SQL no banco de dados conectado e retorna o resultado como um DataFrame Pandas. Inclui tratamento b√°sico de erro.
    * üíæ **Fun√ß√µes de Cache (para o Exerc√≠cio 10):**
        * üì• `carregar_cache_csv(filepath, key_col, value_col)`: Carrega dados de um arquivo CSV para um dicion√°rio em mem√≥ria, servindo como cache.
        * üì§ `salvar_cache_csv(cache_data, filepath, key_name, value_name)`: Salva o conte√∫do do cache em mem√≥ria para um arquivo CSV.
        * üåç `carregar_cache_paises() / salvar_cache_paises()`: Fun√ß√µes espec√≠ficas para o cache da API REST Countries, que armazena dicion√°rios de dados.
    * üîé **Fun√ß√µes de Busca de Dados de APIs (Integradas com Cache):**
        * üå°Ô∏è `_buscar_clima_api(cidade)` e `buscar_clima(cidade)`: A primeira realiza a chamada √† WeatherAPI; a segunda gerencia o cache para os dados de temperatura.
        * üè≠ `_buscar_aqi_cidade_api(cidade, estado, pais)` e `buscar_aqi_cidade(cidade, estado, pais)`: Similarmente, para a AirVisual API, buscando o AQI.
        * üåç `_buscar_dados_pais_api(nome_pais_api)` e `buscar_dados_pais(nome_pais_pagila)`: Para a REST Countries API, buscando popula√ß√£o, regi√£o, etc. Inclui um mapa (`country_name_map_rest`) para normalizar nomes de pa√≠ses entre o Pagila e a API.
    * ‚è≥ As fun√ß√µes de API incluem um pequeno `time.sleep()` para evitar sobrecarregar os servidores das APIs.

---

**üìù Resumo Detalhado dos Exerc√≠cios:**

* **üéØ Exerc√≠cio 1 ‚Äì Temperatura M√©dia das Cidades dos Clientes:**
    * **Objetivo:** Calcular a temperatura m√©dia das cidades que possuem clientes com mais de 10 transa√ß√µes totais, ponderada pelo n√∫mero de clientes distintos em cada uma dessas cidades.
    * **Fontes:** Pagila (tabelas `city`, `address`, `customer`, `payment`), WeatherAPI.
    * **L√≥gica:** Uma consulta SQL obt√©m as cidades, o n√∫mero de clientes e o total de transa√ß√µes (para o filtro). Para uma amostra dessas cidades (as 20 com mais clientes), busca-se a temperatura via `buscar_clima()`. A m√©dia ponderada da temperatura √© calculada usando `num_clientes` como peso.
    * **Sa√≠da:** Temperatura m√©dia ponderada e listas de cidades (da amostra) com as temperaturas mais altas e mais baixas, e com mais clientes.

* **üí∞ Exerc√≠cio 2 ‚Äì Receita Bruta em Cidades com Clima Ameno:**
    * **Objetivo:** Identificar o faturamento total proveniente de cidades onde a temperatura atual est√° entre 18¬∞C e 24¬∞C.
    * **Fontes:** Pagila (tabelas `payment`, `customer`, `address`, `city`), WeatherAPI.
    * **L√≥gica:** Uma consulta SQL calcula a receita bruta por cidade. Para uma amostra dessas cidades (as 30 com maior receita), a temperatura √© obtida. Os dados s√£o filtrados pela faixa de temperatura especificada e a receita bruta total dessas cidades √© somada.
    * **Sa√≠da:** Lista de cidades (amostra) com clima ameno e sua receita, e o faturamento total dessas cidades.

* **üåç Exerc√≠cio 3 ‚Äì Aluguel de Filmes por Pa√≠s e Popula√ß√£o:**
    * **Objetivo:** Calcular o n√∫mero de alugu√©is por 1.000 habitantes para cada pa√≠s, visando identificar os pa√≠ses proporcionalmente mais "cin√©filos".
    * **Fontes:** Pagila (tabelas `rental`, `customer`, `address`, `city`, `country`), REST Countries API.
    * **L√≥gica:** Consulta SQL para obter o n√∫mero total de alugu√©is por pa√≠s. Em seguida, para cada pa√≠s, a fun√ß√£o `buscar_dados_pais()` (com cache) obt√©m a popula√ß√£o. √â calculada a m√©trica de alugu√©is por 1.000 habitantes.
    * **Sa√≠da:** Ranking dos 5 pa√≠ses mais "cin√©filos" com base na m√©trica calculada.

* **üé¨ Exerc√≠cio 4 ‚Äì Filmes Mais Populares em Cidades Polu√≠das:**
    * **Objetivo:** Listar os filmes mais alugados nas 10 cidades com maior n√∫mero de clientes que tamb√©m apresentam um √çndice de Qualidade do Ar (AQI) superior a 150.
    * **Fontes:** Pagila (tabelas `customer`, `address`, `city`, `country`, `rental`, `inventory`, `film`), AirVisual API.
    * **L√≥gica:**
        1.  Identificar as 10 cidades com mais clientes (com detalhes de distrito e pa√≠s).
        2.  Para essas cidades, buscar o AQI usando `buscar_aqi_cidade()` (que utiliza um mapa `country_name_map_airvisual` para adequar nomes de pa√≠ses e heur√≠sticas para o "estado").
        3.  Filtrar as cidades com AQI > 150.
        4.  Para essas cidades polu√≠das, executar uma nova consulta SQL para encontrar os filmes mais alugados.
    * **Sa√≠da:** Listas de filmes populares para cada cidade polu√≠da identificada na amostra, seguida de uma discuss√£o sobre a complexidade de inferir causalidade entre polui√ß√£o e prefer√™ncia de filmes.

* **üßë‚Äçüíº Exerc√≠cio 5 ‚Äì Clientes em √Åreas Cr√≠ticas:**
    * **Objetivo:** Identificar clientes que residem em cidades com AQI > 130 e apresentar um perfil combinado (nome, cidade, pa√≠s, temperatura, AQI), classificando-os como "zona de aten√ß√£o ambiental".
    * **Fontes:** Pagila (clientes, localiza√ß√£o), AirVisual API, WeatherAPI.
    * **L√≥gica:** Obter uma lista de cidades distintas dos clientes. Para uma amostra de 50 dessas cidades, buscar o AQI e a temperatura. Filtrar as cidades com AQI > 130. Em seguida, buscar os clientes que residem nessas cidades cr√≠ticas e combinar os dados.
    * **Sa√≠da:** Se encontradas, lista de cidades cr√≠ticas e, subsequentemente, uma tabela com os clientes dessas √°reas e seus dados ambientais. (Na execu√ß√£o de exemplo, nenhuma cidade na amostra atingiu o crit√©rio de AQI).

* **üåé Exerc√≠cio 6 ‚Äì Receita por Continente:**
    * **Objetivo:** Calcular e visualizar a distribui√ß√£o da receita total da locadora por continente.
    * **Fontes:** Pagila (pagamentos, localiza√ß√£o), REST Countries API.
    * **L√≥gica:** Consulta SQL para obter a receita total por pa√≠s. Usar `buscar_dados_pais()` para obter a regi√£o (continente) de cada pa√≠s. Agrupar a receita por regi√£o e calcular a soma.
    * **Sa√≠da:** Tabela com a receita total por continente e um gr√°fico de pizza (`matplotlib`) mostrando essa distribui√ß√£o.

* **‚è±Ô∏è Exerc√≠cio 7 ‚Äì Tempo M√©dio de Aluguel vs Clima:**
    * **Objetivo:** Calcular o tempo m√©dio de aluguel de filmes por cidade e analisar visualmente sua correla√ß√£o com a temperatura atual dessas cidades.
    * **Fontes:** Pagila (tabelas `rental`, `customer`, `address`, `city`), WeatherAPI.
    * **L√≥gica:** Consulta SQL para calcular o tempo m√©dio de aluguel em segundos por cidade, considerando apenas cidades com mais de 20 alugu√©is. Converter para dias. Obter a temperatura atual para essas cidades.
    * **Sa√≠da:** Tabela com tempo m√©dio de aluguel e temperatura, um scatterplot (`seaborn`) mostrando a rela√ß√£o e o coeficiente de correla√ß√£o de Pearson.

* **üë§ Exerc√≠cio 8 ‚Äì Perfil de Clima por Cliente:**
    * **Objetivo:** Para uma amostra de clientes, criar um perfil detalhado (cidade, temperatura, AQI, total de alugu√©is, gasto total). Agrupar esses perfis por uma faixa et√°ria simulada para identificar poss√≠veis padr√µes de consumo em rela√ß√£o a fatores ambientais.
    * **Fontes:** Pagila, WeatherAPI, AirVisual API.
    * **L√≥gica:** Consulta SQL para dados base do cliente. Para uma amostra de cidades, buscar temperatura e AQI. Fazer o merge. Simular faixas et√°rias. Agrupar e analisar m√©dias de gasto.
    * **Sa√≠da:** Tabelas mostrando o perfil de cliente (amostra), gasto total m√©dio por faixa et√°ria simulada, e por faixa et√°ria e qualidade do ar.

* **üì§ Exerc√≠cio 9 ‚Äì Exporta√ß√£o Inteligente:**
    * **Objetivo:** Gerar um relat√≥rio Excel com m√∫ltiplas abas, contendo clientes que atendem a crit√©rios ambientais e de consumo espec√≠ficos.
    * **Fontes:** Dados processados do Exerc√≠cio 8.
    * **L√≥gica:** Filtrar o DataFrame de perfis de clientes com base nos crit√©rios (temperatura < 15¬∞C, AQI > 100, gasto > m√©dia). Preparar DataFrames para abas ("Clientes\_Criticos", "Condicoes\_Temperatura", "Alertas\_Ambientais\_Consumo"). Escrever para Excel.
    * **Sa√≠da:** Mensagem sobre a gera√ß√£o do relat√≥rio. (Na execu√ß√£o de exemplo, nenhum cliente da amostra satisfez os filtros).

* **üóÉÔ∏è Exerc√≠cio 10 ‚Äì API Cache Inteligente (Desafio):**
    * **Objetivo:** Demonstrar a funcionalidade do sistema de cache implementado para as chamadas √†s APIs.
    * **L√≥gica:** As fun√ß√µes de cache e as fun√ß√µes de API modificadas s√£o definidas anteriormente. Esta c√©lula executa chamadas de teste, mostrando "CACHE HIT" ou "API CALL".
    * **Sa√≠da:** Logs de teste do cache.

---

**üìå Considera√ß√µes Finais e Fechamento:**
* O notebook conclui com fechamento opcional da conex√£o com o banco.
* ‚ö†Ô∏è **Avisos:** `UserWarning` do Pandas (sugest√£o de SQLAlchemy) e `SettingWithCopyWarning`s (tratados com `.copy()` e `.loc`).
* ‚ö° **Efici√™ncia:** Uso de amostras (`.head(N)`, `.sample(N)`) para agilidade e para evitar limites de API.

**üèÜ Aprendizados Chave Esperados:**
Ao completar este notebook, o usu√°rio deve ganhar experi√™ncia pr√°tica em:
* üîó Conectar Python a PostgreSQL e executar SQL.
* üåê Consumir dados de APIs RESTful.
* üßπ Limpar, transformar, e combinar dados de m√∫ltiplas fontes (Pandas).
* üîë Gerenciar chaves de API.
* üíæ Implementar cache para otimizar chamadas de API.
* üìä Realizar an√°lises explorat√≥rias e gerar visualiza√ß√µes.
* üì§ Exportar resultados para Excel.
* üõ†Ô∏è Lidar com desafios pr√°ticos de integra√ß√£o de dados.